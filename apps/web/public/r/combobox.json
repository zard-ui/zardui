{
  "name": "combobox",
  "type": "registry:component",
  "files": [
    {
      "name": "combobox.component.ts",
      "content": "import {\n  afterNextRender,\n  ChangeDetectionStrategy,\n  Component,\n  computed,\n  ElementRef,\n  forwardRef,\n  inject,\n  Injector,\n  input,\n  output,\n  runInInjectionContext,\n  signal,\n  viewChild,\n  ViewEncapsulation,\n} from '@angular/core';\nimport { type ControlValueAccessor, FormsModule, NG_VALUE_ACCESSOR } from '@angular/forms';\n\nimport type { ClassValue } from 'clsx';\n\nimport { comboboxVariants, type ZardComboboxVariants } from './combobox.variants';\nimport { ZardButtonComponent } from '../button/button.component';\nimport { ZardCommandEmptyComponent } from '../command/command-empty.component';\nimport { ZardCommandInputComponent } from '../command/command-input.component';\nimport { ZardCommandListComponent } from '../command/command-list.component';\nimport { ZardCommandOptionGroupComponent } from '../command/command-option-group.component';\nimport { ZardCommandOptionComponent } from '../command/command-option.component';\nimport { ZardCommandComponent, type ZardCommandOption } from '../command/command.component';\nimport { ZardEmptyComponent } from '../empty/empty.component';\nimport { ZardIconComponent } from '../icon/icon.component';\nimport type { ZardIcon } from '../icon/icons';\nimport { ZardPopoverComponent, ZardPopoverDirective } from '../popover/popover.component';\n\nimport { mergeClasses } from '@/shared/utils/merge-classes';\n\nexport interface ZardComboboxOption {\n  value: string;\n  label: string;\n  disabled?: boolean;\n  icon?: ZardIcon;\n}\n\nexport interface ZardComboboxGroup {\n  label?: string;\n  options: ZardComboboxOption[];\n}\n\n@Component({\n  selector: 'z-combobox',\n  imports: [\n    FormsModule,\n    ZardButtonComponent,\n    ZardCommandComponent,\n    ZardCommandInputComponent,\n    ZardCommandListComponent,\n    ZardCommandEmptyComponent,\n    ZardCommandOptionComponent,\n    ZardCommandOptionGroupComponent,\n    ZardPopoverDirective,\n    ZardPopoverComponent,\n    ZardEmptyComponent,\n    ZardIconComponent,\n  ],\n  template: `\n    <button\n      type=\"button\"\n      z-button\n      zPopover\n      [zContent]=\"popoverContent\"\n      [zType]=\"buttonVariant()\"\n      [class]=\"buttonClasses()\"\n      [disabled]=\"disabled()\"\n      role=\"combobox\"\n      [attr.aria-expanded]=\"open()\"\n      [attr.aria-haspopup]=\"'listbox'\"\n      [attr.aria-controls]=\"'combobox-listbox'\"\n      [attr.aria-label]=\"ariaLabel() || 'Select option'\"\n      [attr.aria-describedby]=\"ariaDescribedBy()\"\n      [attr.aria-autocomplete]=\"searchable() ? 'list' : 'none'\"\n      [attr.aria-activedescendant]=\"null\"\n      (zVisibleChange)=\"setOpen($event)\"\n      #popoverTrigger\n    >\n      <span class=\"flex-1 truncate text-left\">\n        {{ displayValue() ?? placeholder() }}\n      </span>\n      <z-icon zType=\"chevrons-up-down\" class=\"ml-2 shrink-0 opacity-50\" />\n    </button>\n\n    <ng-template #popoverContent>\n      <z-popover [class]=\"popoverClasses()\">\n        <z-command class=\"min-h-auto\" (zCommandSelected)=\"handleSelect($event)\" #commandRef>\n          @if (searchable()) {\n            <z-command-input [placeholder]=\"searchPlaceholder()\" #commandInputRef />\n          }\n\n          <z-command-list id=\"combobox-listbox\" role=\"listbox\">\n            @if (emptyText()) {\n              <z-command-empty>\n                <z-empty [zDescription]=\"emptyText()\" />\n              </z-command-empty>\n            }\n\n            @for (group of groups(); track group.label ?? $index) {\n              @if (group.label) {\n                <z-command-option-group [zLabel]=\"group.label\">\n                  @for (option of group.options; track option.value) {\n                    <z-command-option\n                      [zValue]=\"option.value\"\n                      [zLabel]=\"option.label\"\n                      [zDisabled]=\"option.disabled ?? false\"\n                      [zIcon]=\"option.icon\"\n                      [attr.aria-selected]=\"option.value === getCurrentValue()\"\n                    >\n                      {{ option.label }}\n                      @if (option.value === getCurrentValue()) {\n                        <z-icon zType=\"check\" class=\"ml-auto\" />\n                      }\n                    </z-command-option>\n                  }\n                </z-command-option-group>\n              } @else {\n                @for (option of group.options; track option.value) {\n                  <z-command-option\n                    [zValue]=\"option.value\"\n                    [zLabel]=\"option.label\"\n                    [zDisabled]=\"option.disabled ?? false\"\n                    [zIcon]=\"option.icon\"\n                    [attr.aria-selected]=\"option.value === getCurrentValue()\"\n                  >\n                    {{ option.label }}\n                    @if (option.value === getCurrentValue()) {\n                      <z-icon zType=\"check\" class=\"ml-auto\" />\n                    }\n                  </z-command-option>\n                }\n              }\n            } @empty {\n              @if (options().length > 0) {\n                @for (option of options(); track option.value) {\n                  <z-command-option\n                    [zValue]=\"option.value\"\n                    [zLabel]=\"option.label\"\n                    [zDisabled]=\"option.disabled ?? false\"\n                    [zIcon]=\"option.icon\"\n                    [attr.aria-selected]=\"option.value === getCurrentValue()\"\n                  >\n                    {{ option.label }}\n                    @if (option.value === getCurrentValue()) {\n                      <z-icon zType=\"check\" class=\"ml-auto\" />\n                    }\n                  </z-command-option>\n                }\n              }\n            }\n          </z-command-list>\n        </z-command>\n      </z-popover>\n    </ng-template>\n  `,\n  providers: [\n    {\n      provide: NG_VALUE_ACCESSOR,\n      useExisting: forwardRef(() => ZardComboboxComponent),\n      multi: true,\n    },\n  ],\n  changeDetection: ChangeDetectionStrategy.OnPush,\n  encapsulation: ViewEncapsulation.None,\n  host: {\n    '[class]': 'classes()',\n    '(document:keydown.escape)': 'onDocumentKeyDown($event)',\n    '(keydown.escape.prevent-with-stop)': 'onKeyDownEscape()',\n    '(keydown.{arrowdown,arrowup,enter,home,end,pageup,pagedown,space}.prevent)': 'onKeyDown($event)',\n    '(keydown.tab)': 'onKeyDown($event)',\n  },\n  exportAs: 'zCombobox',\n})\nexport class ZardComboboxComponent implements ControlValueAccessor {\n  private readonly injector = inject(Injector);\n\n  readonly class = input<ClassValue>('');\n  readonly buttonVariant = input<'default' | 'outline' | 'secondary' | 'ghost'>('outline');\n  readonly zWidth = input<ZardComboboxVariants['zWidth']>('default');\n  readonly placeholder = input<string>('Select...');\n  readonly searchPlaceholder = input<string>('Search...');\n  readonly emptyText = input<string>('No results found.');\n  readonly disabled = input<boolean>(false);\n  readonly searchable = input<boolean>(true);\n  readonly value = input<string | null>(null);\n  readonly options = input<ZardComboboxOption[]>([]);\n  readonly groups = input<ZardComboboxGroup[]>([]);\n  readonly ariaLabel = input<string>('');\n  readonly ariaDescribedBy = input<string>('');\n\n  readonly zValueChange = output<string | null>();\n  readonly zComboSelected = output<ZardComboboxOption>();\n\n  readonly popoverDirective = viewChild.required('popoverTrigger', { read: ZardPopoverDirective });\n  readonly buttonRef = viewChild.required('popoverTrigger', { read: ElementRef });\n  readonly commandRef = viewChild('commandRef', { read: ZardCommandComponent });\n  readonly commandInputRef = viewChild('commandInputRef', { read: ZardCommandInputComponent });\n\n  protected readonly open = signal(false);\n  protected readonly internalValue = signal<string | null>(null);\n\n  protected readonly classes = computed(() =>\n    mergeClasses(\n      comboboxVariants({\n        zWidth: this.zWidth(),\n      }),\n      this.class(),\n    ),\n  );\n\n  protected readonly buttonClasses = computed(() => 'w-full justify-between');\n\n  protected readonly popoverClasses = computed(() => {\n    const widthClass = this.zWidth() === 'full' ? 'w-full' : 'w-[200px]';\n    return `${widthClass} p-0`;\n  });\n\n  protected readonly getCurrentValue = computed(() => this.value() ?? this.internalValue());\n\n  protected readonly displayValue = computed(() => {\n    const currentValue = this.getCurrentValue();\n    if (!currentValue) {\n      return null;\n    }\n\n    // Search in groups first\n    if (this.groups().length) {\n      for (const group of this.groups()) {\n        const option = group.options.find(opt => opt.value === currentValue);\n        if (option) {\n          return option.label;\n        }\n      }\n    }\n\n    // Then search in flat options\n    const option = this.options().find(opt => opt.value === currentValue);\n    return option?.label ?? null;\n  });\n\n  private onChange: (value: string | null) => void = () => {\n    // ControlValueAccessor implementation\n  };\n\n  private onTouched: () => void = () => {\n    // ControlValueAccessor implementation\n  };\n\n  setOpen(open: boolean) {\n    this.open.set(open);\n    if (open) {\n      runInInjectionContext(this.injector, () =>\n        afterNextRender(() => {\n          const commandRef = this.commandRef();\n          if (commandRef) {\n            // Refresh options to ensure they're detected\n            commandRef.refreshOptions();\n            // Focus on search input if searchable, otherwise on command component\n            if (this.searchable()) {\n              this.commandInputRef()?.focus();\n            } else {\n              commandRef.focus();\n            }\n          }\n        }),\n      );\n    }\n  }\n\n  handleSelect(commandOption: ZardCommandOption) {\n    const selectedValue = commandOption.value as string;\n\n    // Toggle behavior - if same value is selected, clear it\n    const newValue = selectedValue === this.getCurrentValue() ? null : selectedValue;\n\n    this.internalValue.set(newValue);\n    this.onChange(newValue);\n    this.zValueChange.emit(newValue);\n\n    // Emit the combobox option if we have a selection\n    if (newValue) {\n      let selectedOption: ZardComboboxOption | undefined;\n\n      if (this.groups().length > 0) {\n        for (const group of this.groups()) {\n          selectedOption = group.options.find(opt => opt.value === newValue);\n          if (selectedOption) {\n            break;\n          }\n        }\n      } else {\n        selectedOption = this.options().find(opt => opt.value === newValue);\n      }\n\n      if (selectedOption) {\n        this.zComboSelected.emit(selectedOption);\n      }\n    }\n\n    // Close the popover\n    this.popoverDirective().hide();\n\n    // Return focus to the combobox button after selection\n    this.buttonRef().nativeElement.focus();\n  }\n\n  onKeyDownEscape(): void {\n    if (this.open()) {\n      this.popoverDirective().hide();\n      this.buttonRef().nativeElement.focus();\n    } else if (this.getCurrentValue()) {\n      this.internalValue.set(null);\n      this.onChange(null);\n      this.zValueChange.emit(null);\n    }\n  }\n\n  onKeyDown(e: Event) {\n    if (this.disabled()) {\n      return;\n    }\n\n    const { key, ctrlKey, altKey, metaKey } = e as KeyboardEvent;\n\n    // Handle different keyboard events based on combobox state\n    if (this.open()) {\n      // When popover is open\n      switch (key) {\n        case 'Tab':\n          // Allow tab to close and move to next element\n          this.popoverDirective().hide();\n          break;\n        case 'ArrowDown':\n        case 'ArrowUp':\n        case 'Enter':\n        case 'Home':\n        case 'End':\n        case 'PageUp':\n        case 'PageDown':\n          // Forward navigation to command component\n          this.commandRef()?.onKeyDown(e as KeyboardEvent);\n          break;\n      }\n    } else {\n      // When popover is closed\n      switch (key) {\n        case 'ArrowDown':\n        case 'ArrowUp':\n        case 'Enter':\n        case ' ': // Space key\n          this.popoverDirective().show();\n          break;\n        default:\n          // For searchable comboboxes, open and start typing\n          if (this.searchable() && key.length === 1 && !ctrlKey && !altKey && !metaKey) {\n            this.popoverDirective().show();\n            // Let the command input handle the character after opening\n            runInInjectionContext(this.injector, () =>\n              afterNextRender(() => {\n                const inputElement = this.commandInputRef();\n                if (inputElement) {\n                  inputElement.searchInput().nativeElement.value = key;\n                  inputElement.updateParentComponents(key);\n                  inputElement.focus();\n                }\n              }),\n            );\n          }\n          break;\n      }\n    }\n  }\n\n  // needed when component loses focus by keyboard.\n  onDocumentKeyDown(event: Event) {\n    // Close on Escape from anywhere when this combobox is open\n    if (this.open()) {\n      const target = event.target as Element;\n      const buttonElement = this.buttonRef().nativeElement;\n      // Only handle if not already handled by the component itself\n      if (!buttonElement.contains(target)) {\n        this.popoverDirective().hide();\n        this.buttonRef().nativeElement.focus();\n      }\n    }\n  }\n\n  // ControlValueAccessor implementation\n  writeValue(value: string | null): void {\n    this.internalValue.set(value);\n  }\n\n  registerOnChange(fn: (value: string | null) => void): void {\n    this.onChange = fn;\n  }\n\n  registerOnTouched(fn: () => void): void {\n    this.onTouched = fn;\n  }\n}\n"
    },
    {
      "name": "combobox.variants.ts",
      "content": "import { cva, type VariantProps } from 'class-variance-authority';\n\nexport const comboboxVariants = cva('', {\n  variants: {\n    zWidth: {\n      default: 'w-[200px]',\n      sm: 'w-[150px]',\n      md: 'w-[250px]',\n      lg: 'w-[350px]',\n      full: 'w-full',\n    },\n  },\n  defaultVariants: {\n    zWidth: 'default',\n  },\n});\n\nexport type ZardComboboxVariants = VariantProps<typeof comboboxVariants>;\n"
    }
  ],
  "registryDependencies": [
    "button",
    "command",
    "core",
    "popover",
    "empty",
    "input",
    "icon"
  ]
}
