{
  "name": "dark-mode",
  "type": "registry:component",
  "files": [
    {
      "name": "dark-mode.ts",
      "content": "import { isPlatformBrowser, DOCUMENT } from '@angular/common';\nimport { Injectable, type OnDestroy, PLATFORM_ID, computed, inject, signal } from '@angular/core';\n\nexport enum EDarkModes {\n  LIGHT = 'light',\n  DARK = 'dark',\n  SYSTEM = 'system',\n}\nexport type DarkModeOptions = EDarkModes.LIGHT | EDarkModes.DARK | EDarkModes.SYSTEM;\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class ZardDarkMode implements OnDestroy {\n  private readonly document = inject(DOCUMENT);\n\n  private static readonly STORAGE_KEY = 'theme';\n  private handleThemeChange = (event: MediaQueryListEvent) => this.updateThemeMode(event.matches);\n  private readonly isBrowser = isPlatformBrowser(inject(PLATFORM_ID));\n  private readonly themeSignal = signal<DarkModeOptions>(EDarkModes.SYSTEM);\n  private darkModeQuery?: MediaQueryList;\n\n  readonly theme = computed(() => this.themeSignal());\n\n  readonly themeMode = computed(() => {\n    if (this.themeSignal() === EDarkModes.SYSTEM) {\n      return this.isDarkMode() ? EDarkModes.DARK : EDarkModes.LIGHT;\n    }\n    return this.themeSignal();\n  });\n\n  ngOnDestroy(): void {\n    this.handleSystemChanges(false);\n  }\n\n  init(): void {\n    if (!this.isBrowser) {\n      return;\n    }\n\n    this.applyTheme(this.getStoredTheme() ?? EDarkModes.SYSTEM);\n  }\n\n  toggleTheme(): void {\n    const currentTheme = this.getCurrentTheme();\n    if (!this.isBrowser) {\n      return;\n    }\n\n    if (currentTheme === EDarkModes.SYSTEM) {\n      this.applyTheme(EDarkModes.LIGHT);\n    } else if (currentTheme === EDarkModes.LIGHT) {\n      this.applyTheme(EDarkModes.DARK);\n    } else {\n      this.applyTheme(EDarkModes.SYSTEM);\n    }\n  }\n\n  activateTheme(theme: DarkModeOptions): void {\n    if (!this.isBrowser) {\n      return;\n    }\n\n    this.applyTheme(theme);\n  }\n\n  getCurrentTheme(): DarkModeOptions {\n    return this.themeSignal();\n  }\n\n  private applyTheme(theme: DarkModeOptions): void {\n    if (!this.isBrowser) {\n      return;\n    }\n\n    localStorage.setItem(ZardDarkMode.STORAGE_KEY, theme);\n    this.themeSignal.set(theme);\n    // whenever we apply theme call listener removal\n    this.handleSystemChanges(false);\n\n    this.darkModeQuery ??= this.getDarkModeQuery();\n    this.updateThemeMode(this.isDarkMode());\n    if (theme === EDarkModes.SYSTEM) {\n      this.handleSystemChanges(true);\n    }\n  }\n\n  private getStoredTheme(): DarkModeOptions | undefined {\n    if (!this.isBrowser) {\n      return undefined;\n    }\n\n    const value = localStorage.getItem(ZardDarkMode.STORAGE_KEY);\n    if (value === EDarkModes.LIGHT || value === EDarkModes.DARK || value === EDarkModes.SYSTEM) {\n      return value;\n    }\n    return undefined;\n  }\n\n  private getThemeMode(isDarkMode: boolean): EDarkModes.LIGHT | EDarkModes.DARK {\n    return isDarkMode ? EDarkModes.DARK : EDarkModes.LIGHT;\n  }\n\n  private updateThemeMode(isDarkMode: boolean): void {\n    const themeMode = this.getThemeMode(isDarkMode);\n    const html = this.document.documentElement;\n    html.classList.toggle('dark', isDarkMode);\n    html.setAttribute('data-theme', themeMode);\n    html.style.colorScheme = themeMode;\n  }\n\n  private getDarkModeQuery(): MediaQueryList | undefined {\n    if (!this.isBrowser) {\n      return;\n    }\n    return this.document.defaultView?.matchMedia('(prefers-color-scheme: dark)');\n  }\n\n  private isDarkMode(): boolean {\n    if (!this.isBrowser) {\n      return false;\n    }\n\n    const isSystemDarkMode = this.darkModeQuery?.matches ?? false;\n    const stored = localStorage.getItem(ZardDarkMode.STORAGE_KEY);\n    return stored === EDarkModes.DARK || (stored === EDarkModes.SYSTEM && isSystemDarkMode);\n  }\n\n  private handleSystemChanges(addListener: boolean): void {\n    if (addListener) {\n      this.darkModeQuery?.addEventListener('change', this.handleThemeChange);\n    } else {\n      this.darkModeQuery?.removeEventListener('change', this.handleThemeChange);\n    }\n  }\n}\n"
    }
  ],
  "basePath": "services",
  "registryDependencies": [
    "core"
  ]
}
