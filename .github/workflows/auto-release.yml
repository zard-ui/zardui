name: ðŸš€ Auto Release on Merge

on:
  push:
    branches:
      - master
    paths-ignore:
      - '**/CHANGELOG.md'
      - '.github/workflows/production-deploy.yml'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  detect-release:
    name: ðŸ” Detect if Release Needed
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      bump_type: ${{ steps.check.outputs.bump_type }}
      feature_count: ${{ steps.check.outputs.feature_count }}
      fix_count: ${{ steps.check.outputs.fix_count }}
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ” Analyze commits for release
        id: check
        run: npx tsx scripts/should-release.cts

  release:
    name: ðŸš€ Create Release
    runs-on: ubuntu-latest
    needs: detect-release
    if: needs.detect-release.outputs.should_release == 'true'
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ðŸ¤– Configure Git
        run: |
          git config --global user.email "shrizzon@gmail.com"
          git config --global user.name "Samuel Rizzon"

      - name: ðŸ“¥ Install dependencies
        run: npm ci

      - name: ðŸ“Š Release Summary (Pre)
        run: |
          echo "## ðŸŽ¯ Release Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Bump Type**: ${{ needs.detect-release.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Features**: ${{ needs.detect-release.outputs.feature_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Fixes**: ${{ needs.detect-release.outputs.fix_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: ðŸŽ¯ Run Nx Release
        id: nx_release
        run: |
          echo "Git status before release:"
          git status
          echo ""
          echo "Bump type detected: ${{ needs.detect-release.outputs.bump_type }}"
          echo ""

          # Check if there are any existing release tags
          if git describe --tags --abbrev=0 2>/dev/null; then
            echo "Found existing tags, running normal release"
            npx nx release --skip-publish --verbose ${{ needs.detect-release.outputs.bump_type }}
          else
            echo "No existing tags found, running first release"
            npx nx release --skip-publish --first-release --verbose ${{ needs.detect-release.outputs.bump_type }}
          fi

          echo ""
          echo "Git status after release:"
          git status
          echo ""
          echo "Recent commits:"
          git log --oneline -3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Push Changes and Tags
        run: |
          echo "Checking git status before push..."
          git status
          echo ""
          echo "Checking for new tags..."
          git tag -l --sort=-version:refname | head -5
          echo ""
          echo "Pushing changes and tags..."
          git push origin master --follow-tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸŽ‰ Success Summary
        run: |
          # Extract the new version from the last tag
          NEW_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "unknown")

          echo "## âœ… Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$NEW_VERSION" != "unknown" ]; then
            echo "### ðŸ·ï¸ Version" >> $GITHUB_STEP_SUMMARY
            echo "\`$NEW_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "### ðŸ“¦ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… CHANGELOG.md updated" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Version bumped in package.json" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Git tag created" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ NPM publish workflow will be triggered automatically" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ GitHub Release will be created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$NEW_VERSION" != "unknown" ]; then
            echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
            echo "- [View on GitHub](https://github.com/${{ github.repository }}/releases/tag/$NEW_VERSION)" >> $GITHUB_STEP_SUMMARY
            echo "- [View Changelog](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md)" >> $GITHUB_STEP_SUMMARY
          fi

  skip-release:
    name: â­ï¸ Skip Release
    runs-on: ubuntu-latest
    needs: detect-release
    if: needs.detect-release.outputs.should_release == 'false'
    steps:
      - name: ðŸ“Š Skip Summary
        run: |
          echo "## â­ï¸ Release Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No changes that require a release were detected." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Commit Types that Trigger Releases:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ¨ **feat** â†’ Minor version bump" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ› **fix** â†’ Patch version bump" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ **perf** â†’ Patch version bump" >> $GITHUB_STEP_SUMMARY
          echo "- âªï¸ **revert** â†’ Patch version bump" >> $GITHUB_STEP_SUMMARY
          echo "- **Breaking changes** (!) â†’ Major version bump" >> $GITHUB_STEP_SUMMARY
